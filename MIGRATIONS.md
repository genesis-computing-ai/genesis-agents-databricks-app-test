# Database Migrations Guide

This application uses **Alembic** for automatic database schema migrations. Migrations run automatically on application startup, ensuring customer deployments always have the latest schema.

## How It Works

1. **On Startup**: The app automatically runs `db_init.init_database()`
2. **Migration Check**: Checks current database revision vs. latest migration
3. **Auto-Apply**: Applies any pending migrations automatically
4. **Fallback**: If no migrations exist, creates tables using `metadata.create_all()`

## Creating New Migrations

When you add/modify columns in `db_schema.py`, create a new migration:

### Step 1: Generate Migration

```bash
alembic revision --autogenerate -m "add tags column to todos"
```

This will:
- Compare your current `db_schema.py` with the database
- Generate a migration file in `alembic/versions/`
- Include upgrade/downgrade functions

### Step 2: Review Migration File

**Always review the generated migration** before committing:

```bash
# Check what was generated
cat alembic/versions/XXXX_add_tags_column_to_todos.py
```

Common things to check:
- ✅ Correct column types
- ✅ Correct constraints (nullable, defaults)
- ✅ Data migration if needed (e.g., setting default values for existing rows)
- ✅ Index creation if needed

### Step 3: Test Migration Locally

```bash
# Apply migration
alembic upgrade head

# Test your app
python app.py

# Rollback if needed (for testing)
alembic downgrade -1
```

### Step 4: Commit Migration

```bash
git add alembic/versions/XXXX_add_tags_column_to_todos.py
git commit -m "Add tags column to todos table"
```

## Migration Workflow for Schema Changes

1. **Modify Schema**: Edit `db_schema.py` (add/modify columns)
2. **Generate Migration**: `alembic revision --autogenerate -m "description"`
3. **Review & Edit**: Check the generated migration file
4. **Test Locally**: `alembic upgrade head` and test your app
5. **Commit**: Include migration file in your commit
6. **Deploy**: On customer deployment, migrations run automatically on startup

## Example: Adding a New Column

### 1. Update Schema (`db_schema.py`)

```python
todos_table = Table(
    "todos",
    metadata,
    # ... existing columns ...
    Column("tags", String(500), nullable=True),  # NEW COLUMN
)
```

### 2. Generate Migration

```bash
alembic revision --autogenerate -m "add tags column"
```

### 3. Review Generated Migration

The migration will look like:

```python
def upgrade() -> None:
    op.add_column('todos', sa.Column('tags', sa.String(length=500), nullable=True))

def downgrade() -> None:
    op.drop_column('todos', 'tags')
```

### 4. Test & Deploy

- Test locally
- Commit migration file
- Deploy - migrations run automatically on startup

## Manual Migrations

For complex changes, you can create migrations manually:

```bash
alembic revision -m "custom migration description"
```

Then edit the generated file to add your custom SQL/operations.

## Important Notes

- **Always review autogenerated migrations** - Alembic may miss some changes
- **Test migrations locally** before deploying to customers
- **Migration files are version controlled** - they're part of your codebase
- **Migrations run automatically** - customers don't need to run any commands
- **Downgrades are supported** - but use carefully in production

## Troubleshooting

### Migration fails on startup

Check logs for the specific error. Common issues:
- Database connection problems
- Migration conflicts
- Missing dependencies

### Schema out of sync

If schema gets out of sync:
1. Check current revision: `alembic current`
2. Check latest revision: `alembic heads`
3. Apply manually: `alembic upgrade head`

### Fresh database

For a completely fresh database, migrations will run automatically. If migrations don't exist yet, the app falls back to `create_all()`.

